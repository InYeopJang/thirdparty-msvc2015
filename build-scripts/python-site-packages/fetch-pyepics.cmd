@setlocal enableextensions
::
:: Use pip to install pyepics module
::
@echo Setting up pyepics

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Setup environment. Important to ensure correct detection of environment
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
@call %~dp0..\cmds\common-setup.cmd
@set PYTHON_EXTRAS_DIR=%~dp0..\extras\python

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Install the python parts
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
@call %PYTHON_INSTALL_PREFIX%\Scripts\pip.cmd install pyepics

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Install the EPICS libraries
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
@set SRC_PKG_URL="http://aps.anl.gov/epics/download/distributions/EPICSWindowsTools1.44-x64.msi"
@set SRC_PKG=EPICSWindowsTools1.44-x64.msi
@set BUILD_DIR=%BUILD_ROOT%\EPICS

@call try-mkdir.cmd %BUILD_DIR%
@cd %BUILD_DIR%
@call download-file.cmd %SRC_PKG% %SRC_PKG_URL%
@set LOCAL_INSTALL_DIR=%BUILD_DIR%\local
:: Requires user intervention unfortunately
@call msiexec.exe /i %SRC_PKG% TARGETDIR=%LOCAL_INSTALL_DIR% /l*v epics.log

:: Copy over required files
cd %LOCAL_INSTALL_DIR%
@set EPICS_FILES=ca.dll Com.dll msvcr120.dll msvcp120.dll caRepeater.exe
for %%F in (%EPICS_FILES%) do (
  @copy %%F %PYTHON_INSTALL_PREFIX%\Lib\site-packages\epics\%%F /Y
)

:: Remove
@cd %BUILD_DIR%
@call msiexec.exe /x %SRC_PKG% /l*v epics-uninstall.log

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Post-process
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Finalize
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
@call try-pause.cmd
goto:eof